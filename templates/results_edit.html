{% extends "base.html" %}
{% block content %}

<h2 style="text-align:center;">成績編集（一覧）</h2>

<!-- 期間フィルタ（成績管理と同様のパラメータ） -->
<form method="get" action="{{ url_for('results_edit_index') }}" style="margin: 1rem 0; display:flex; gap: 1rem; align-items:center; justify-content:center;">
  <div>
    <label>開始日：</label>
    <input type="date" name="start" value="{{ start or '' }}">
  </div>
  <div>
    <label>終了日：</label>
    <input type="date" name="end" value="{{ end or '' }}">
  </div>
  <button type="submit" class="btn">再表示</button>
  <a class="btn btn-outline" href="{{ url_for('results_index', start=start, end=end) }}">成績管理に戻る</a>
</form>

<div style="display:flex; justify-content:flex-end; gap: 0.5rem; margin: 0.25rem 0 0.75rem;">
  <a class="btn btn-outline" href="{{ url_for('results_edit_export_csv', start=start, end=end) }}">CSV出力</a>
  <a class="btn" href="{{ url_for('results_edit_new', start=start, end=end) }}">
    ＋ 対局追加
  </a>
</div>

<div style="max-height:500px; overflow-y:auto; overflow-x:auto; border:1px solid #ccc;">
  <table class="table" style="width:100%; min-width:960px; border-collapse:collapse;">
    <thead style="position:sticky; top:0; background:#fff; z-index:1;">
      <tr>
        <th style="text-align:left; white-space:nowrap;">対局日時</th>
        <th style="text-align:left;">対局者</th>
        <th style="text-align:left;">駒落ち</th>
        <th style="text-align:left;">勝敗</th>
        <th style="text-align:left;">備考</th>
        <th style="text-align:right;"></th>
      </tr>
    </thead>
    <tbody id="edit-list-body">
      {% if rows and rows|length > 0 %}
        {% for r in rows %}
          <tr data-id="{{ r.id }}">
            <td style="text-align:left; white-space:nowrap;">
              {{ r.ended or "-" }}
            </td>
            <td style="text-align:left;">{{ r.p1 }} vs {{ r.p2 }}</td>
            <td style="text-align:left;">{{ r.handicap }}</td>
            <td style="text-align:left;">{{ r.res1 }} / {{ r.res2 }}</td>
            <td style="text-align:left;">{{ r.note }}</td>
            <td style="text-align:right; white-space:nowrap;">
              <a class="btn btn-sm" href="{{ url_for('results_edit_detail', match_id=r.id, start=start, end=end) }}">編集</a>
              <button class="btn btn-sm btn-danger" onclick="deleteMatch({{ r.id }})">削除</button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="6" style="text-align:center; padding:1rem;">対象期間のデータがありません</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
async function deleteMatch(matchId) {
  if (!confirm("この対局を削除してよろしいですか？")) return;

  try {
    const res = await fetch(`/api/results/match/${matchId}/delete`, { method: "POST" });
    const json = await res.json();
    if (json.success) {
      const tr = document.querySelector(`tr[data-id="${matchId}"]`);
      if (tr) tr.remove();
    } else {
      alert(json.message || "削除に失敗しました");
    }
  } catch (e) {
    alert("通信エラーが発生しました");
  }
}
</script>

{% endblock %}
