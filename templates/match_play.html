{% extends "base.html" %}

{% block content %}
<h2 style="text-align: center;">å¯¾å±€é€²è¡Œãƒ•ã‚§ãƒ¼ã‚º</h2>

<div style="text-align: center; margin-bottom: 1.5rem;">
  <a href="{{ url_for('match_edit') }}" class="btn">â† å‚åŠ è€…ç·¨é›†ã«æˆ»ã‚‹</a>
  <a href="{{ url_for('export_today_participants_csv') }}" class="btn" style="margin-left: 0.75rem;">
    æœ¬æ—¥ã®å‚åŠ è€…CSVå‡ºåŠ›
  </a>
  <button id="end-all-button" class="btn-danger" style="margin-left: 0.75rem;">
    å¯¾å±€ã‚’ã™ã¹ã¦çµ‚äº†ã™ã‚‹
  </button>
</div>

<div id="match-play-container" style="display: flex; gap: 30px; height: 700px;">

  <!-- ğŸ”½ æŒ‡å°å¯¾å±€ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="shido-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.4); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background-color: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px #666;
                max-width: 400px; width: 90%; text-align: center; margin: auto;">
      <p style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">
        ã“ã®å¯¾å±€ã¯æŒ‡å°å¯¾å±€ã§ã™ã€‚è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ
      </p>
      <p style="font-size: 0.8rem; color: #d63535; margin-bottom: 1rem;">
        æ˜‡æ®µç´šãŒã‚ã‚‹å ´åˆã¯ã€å¿…ãšè¨˜éŒ²ã—ã¦ãã ã•ã„
      </p>
      <div style="display: flex; justify-content: space-around;">
        <button id="shido-save">è¨˜éŒ²ã™ã‚‹</button>
        <button id="shido-norecord">è¨˜éŒ²ã—ãªã„</button>
        <button id="shido-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”½ æ˜‡æ®µç´šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="shodan-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background-color: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px #333;
                max-width: 420px; width: 90%; text-align: center; margin: auto;">
      <h3 style="margin-bottom: 1rem;">æ˜‡æ®µç´šã®è¨­å®š</h3>

      <div style="margin-bottom: 1rem;">
        <label for="shodan-player-select">å¯¾è±¡è€…ï¼š</label>
        <select id="shodan-player-select">
          <option value="p1">å¯¾å±€è€…1</option>
          <option value="p2">å¯¾å±€è€…2</option>
        </select>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label for="shodan-grade-select">æ–°ã—ã„æ£‹åŠ›ï¼š</label>
        <select id="shodan-grade-select">
          <!-- JavaScriptã§optionã‚’æŒ¿å…¥ -->
        </select>
      </div>

      <div style="display: flex; justify-content: space-around;">
        <button id="shodan-confirm">æ˜‡æ®µç´šã™ã‚‹</button>
        <button id="shodan-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”½ æœ¬æ—¥2å›ç›®ä»¥ä¸Šã®å¯¾å±€è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="repeat-match-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.4); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background-color: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px #666;
                max-width: 400px; width: 90%; text-align: center; margin: auto;">
      <p id="repeat-match-message" style="font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
        æœ¬æ—¥2å›ç›®ã®å¯¾å±€ã§ã™ã€‚
      </p>
      <div style="display: flex; justify-content: space-around;">
        <button id="repeat-match-continue">ãã‚Œã§ã‚‚å¯¾å±€ã™ã‚‹</button>
        <button id="repeat-match-cancel">æ‰‹åˆã„è§£é™¤</button>
      </div>
    </div>
  </div>  

  <!-- ğŸ”½ ãã®æ—¥ã®çµ‚äº† æœ€çµ‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="end-all-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.45); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background-color: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 10px #333;
                max-width: 420px; width: 90%; text-align: center; margin: auto;">
      <p style="font-size: 1.05rem; font-weight: bold; margin-bottom: 1rem;">
        æœ¬æ—¥ã®å¯¾å±€ã‚’ã™ã¹ã¦çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ
      </p>
      <div style="display: flex; justify-content: space-around;">
        <button id="end-all-yes">ã¯ã„</button>
        <button id="end-all-no">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <!-- å·¦ã‚«ãƒ©ãƒ ï¼šæœ¬æ—¥ã®å‚åŠ è€…ãƒªã‚¹ãƒˆ -->
  <div id="participants-column" style="width: 45%; border: 1px solid #ccc; padding-right: 8px; display: flex; flex-direction: column;">
    <div style="text-align: center; margin-bottom: 0.3rem;">
      <span style="font-weight: bold;">æœ¬æ—¥ã®å‚åŠ è€…</span>
      <span>ï¼ˆé …ç›®åã‚’ã‚¯ãƒªãƒƒã‚¯ã§ä¸¦ã³æ›¿ãˆå¯èƒ½ï¼‰</span>
    </div>
    <div id="participants-table-wrapper" style="flex: 1; overflow-y: auto;">
      <table class="table table-bordered" style="width: 100%;">
        <thead style="position: sticky; top: 0; background: #fff; z-index: 1;">
          <tr>
            <th>
              <a class="participant-header" href="{{ url_for('match_play', sort='member_code', order='asc' if sort != 'member_code' or order == 'desc' else 'desc') }}">ä¼šå“¡ID</a>
            </th>
            <th>
              <a class="participant-header" href="{{ url_for('match_play', sort='name', order='asc' if sort != 'name' or order == 'desc' else 'desc') }}">åå‰</a>
            </th>
            <th>
              <a class="participant-header" href="{{ url_for('match_play', sort='kana', order='asc' if sort != 'kana' or order == 'desc' else 'desc') }}">ã‚ˆã¿ãŒãª</a>
            </th>
            <th>
              <a class="participant-header" href="{{ url_for('match_play', sort='grade', order='asc' if sort != 'grade' or order == 'desc' else 'desc') }}">æ£‹åŠ›</a>
            </th>
            <th>
              <a class="participant-header" href="{{ url_for('match_play', sort='member_type', order='asc' if sort != 'member_type' or order == 'desc' else 'desc') }}">ä¼šå“¡ç¨®é¡</a>
            </th>
          </tr>
        </thead>
        <tbody id="participant-list">
          {% for p in participants %}
            <tr draggable="true" ondragstart="drag(event)" id="participant-{{ p.id }}">
              <td>{{ p.member_code }}</td>
              <td>{{ p.name }}</td>
              <td>{{ p.kana }}</td>
              <td>{{ p.grade }}</td>
              <td>{{ p.member_type }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- å³ã‚«ãƒ©ãƒ ï¼šå¯¾å±€ã‚«ãƒ¼ãƒ‰ -->
  <div id="cards-column" style="width: 55%; border: 1px solid #ccc; padding-right: 8px; display: flex; flex-direction: column;">
    <div style="text-align: center; margin-bottom: 0.3rem;">
      <span style="font-weight: bold;">å¯¾å±€ã‚«ãƒ¼ãƒ‰</span>
    </div>
    <div id="cards-container" style="flex: 1; overflow-y: auto;">
      <!-- ã“ã“ã« JavaScript ã§å¯¾å±€ã‚«ãƒ¼ãƒ‰ã‚’æç”» -->
    </div>

    <div style="text-align: right; margin-top: 1rem;">
      <button onclick="addMatchCard()">ï¼‹ å¯¾å±€ã‚«ãƒ¼ãƒ‰ã‚’1æšè¿½åŠ </button>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- å¤–éƒ¨JSèª­ã¿è¾¼ã¿ -->
<script src="{{ url_for('static', filename='js/match_play.js') }}"></script>

<script id="strength-data" type="application/json">
  {{ strength_order_map | tojson }}
</script>
<script id="handicap-map" type="application/json">
  {{ handicap_map | tojson }}
</script>
<script id="handicap-list" type="application/json">
  {{ handicap_list | tojson }}
</script>

<script>
  window.strengthOrderMap = JSON.parse(document.getElementById("strength-data").textContent);
  window.handicapMap = JSON.parse(document.getElementById("handicap-map").textContent);
  window.handicapList = JSON.parse(document.getElementById("handicap-list").textContent);
</script>

<script>
  window.sortKey = "{{ sort | default('member_code') }}";
  window.sortOrder = "{{ order | default('asc') }}";
</script>

{% endblock %}
