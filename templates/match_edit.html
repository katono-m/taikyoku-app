{% extends "base.html" %}
{% block content %}
{% set sort_members = sort_members | default('member_code') %}
{% set order_members = order_members | default('asc') %}
{% set sort_participants = sort_participants | default('member_code') %}
{% set order_participants = order_participants | default('asc') %}

<h2 style="text-align: center;">å‚åŠ è€…ç·¨é›†ãƒ•ã‚§ãƒ¼ã‚º</h2>

<!-- ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
<div style="text-align: center; margin-bottom: 1.5rem;">
  <button type="button" class="btn" id="proceed-button" style="pointer-events: none; opacity: 0.5;">
    å¯¾å±€é€²è¡Œã¸
  </button>
</div>

<div style="display: flex; gap: 30px;">
  <!-- å…¨ä¼šå“¡åç°¿ -->
  <div style="width: 50%;">
    <div style="display: inline-flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
      <h3 style="margin: 0;">å…¨ä¼šå“¡åç°¿</h3>
      <span style="color: #555; font-size: 0.9rem;">â€»é …ç›®åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä¸¦ã³æ›¿ãˆå¯èƒ½</span>
    </div>

    <!-- â–¼â–¼ QRã‚³ãƒ¼ãƒ‰å—ä»˜ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ï¼‰ â–¼â–¼ -->
    <div style="display:flex; align-items:center; gap:.5rem; margin: .25rem 0 .75rem;">
      <label for="qr-input" style="font-weight:600;">QRã‚³ãƒ¼ãƒ‰å—ä»˜ï¼š</label>
      <input id="qr-input" type="text" placeholder="ã“ã“ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã„ãŸã¾ã¾ã‚¹ã‚­ãƒ£ãƒ³"
            style="flex:1; max-width:420px; padding:.4rem; border:1px solid #ccc; border-radius:4px;">
      <button id="qr-clear" class="btn btn-outline" type="button">ã‚¯ãƒªã‚¢</button>
      <!-- â˜…è¿½åŠ ï¼šéŸ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆåˆå›ã‚¯ãƒªãƒƒã‚¯ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã‚’è§£é™¤ï¼‰ -->
      <button id="qr-sound-enable" class="btn btn-outline" type="button" title="åˆå›ã ã‘ã‚¯ãƒªãƒƒã‚¯ã—ã¦éŸ³ã‚’æœ‰åŠ¹åŒ–">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹åŒ–</button>
    </div>

    <!-- â˜…è¿½åŠ ï¼šéŸ³æºï¼ˆ/static/sounds/ ä»¥ä¸‹ã«è¨­ç½®ï¼‰ -->
    <audio id="sound-ok" src="{{ url_for('static', filename='sounds/ok.mp3') }}" preload="auto"></audio>
    <audio id="sound-ng" src="{{ url_for('static', filename='sounds/ng.mp3') }}" preload="auto"></audio>

    <div id="qr-msg" style="color:#555; font-size:.9rem; margin-bottom:.25rem;"></div>
    <!-- â–²â–² ã“ã“ã¾ã§ -->

    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>é¸æŠ</th>
            <th><a class="participant-header" href="{{ url_for('match_edit', sort_members='member_code', order_members='asc' if sort_members != 'member_code' or order_members == 'desc' else 'desc', sort_participants=sort_participants, order_participants=order_participants) }}" style="text-align: left;">ä¼šå“¡ID</a></th> 

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_members='name', order_members='asc' if sort_members != 'name' or order_members == 'desc' else 'desc', sort_participants=sort_participants, order_participants=order_participants) }}" style="text-align: left;">åå‰</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_members='kana', order_members='asc' if sort_members != 'kana' or order_members == 'desc' else 'desc', sort_participants=sort_participants, order_participants=order_participants) }}" style="text-align: left;">ã‚ˆã¿ãŒãª</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_members='grade', order_members='asc' if sort_members != 'grade' or order_members == 'desc' else 'desc', sort_participants=sort_participants, order_participants=order_participants) }}" style="text-align: left;">æ£‹åŠ›</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_members='member_type', order_members='asc' if sort_members != 'member_type' or order_members == 'desc' else 'desc', sort_participants=sort_participants, order_participants=order_participants) }}" style="text-align: left;">ä¼šå“¡ç¨®é¡</a></th>
          </tr>
        </thead>
        <tbody id="members-table">
          {% for m in members %}
          <tr data-id="{{ m.id }}">
            <td><input type="checkbox" class="member-check"></td>
            <td>{{ m.member_code or m.id }}</td>
            <td>{{ m.name }}</td>
            <td>{{ m.kana }}</td>
            <td>{{ m.grade }}</td>
            <td>{{ m.member_type }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <button id="add-button" class="btn" style="margin-top: 12px;">é¸æŠã—ãŸä¼šå“¡ã‚’å‚åŠ å—ä»˜</button>
  </div>

  <!-- æœ¬æ—¥ã®å‚åŠ è€… -->
  <div style="width: 50%;">
    <!-- â–¼ ç©ºç™½ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã§é«˜ã•ã‚’èª¿æ•´ â–¼ -->
    <div style="height:1.5rem;"></div>

    <div style="display: inline-flex; align-items: center; gap: 0.75rem; margin-bottom: 2.0rem;">
      <h3 style="margin: 0;">æœ¬æ—¥ã®å‚åŠ è€…</h3>
      <span style="color: #555; font-size: 0.9rem;">â€»é …ç›®åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä¸¦ã³æ›¿ãˆå¯èƒ½</span>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th><a class="participant-header" href="{{ url_for('match_edit', sort_participants='member_code', order_participants='asc' if sort_participants != 'member_code' or order_participants == 'desc' else 'desc', sort_members=sort_members, order_members=order_members) }}" style="text-align: left;">ä¼šå“¡ID</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_participants='name', order_participants='asc' if sort_participants != 'name' or order_participants == 'desc' else 'desc', sort_members=sort_members, order_members=order_members) }}" style="text-align: left;">åå‰</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_participants='kana', order_participants='asc' if sort_participants != 'kana' or order_participants == 'desc' else 'desc', sort_members=sort_members, order_members=order_members) }}" style="text-align: left;">ã‚ˆã¿ãŒãª</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_participants='grade', order_participants='asc' if sort_participants != 'grade' or order_participants == 'desc' else 'desc', sort_members=sort_members, order_members=order_members) }}" style="text-align: left;">æ£‹åŠ›</a></th>

            <th><a class="participant-header" href="{{ url_for('match_edit', sort_participants='member_type', order_participants='asc' if sort_participants != 'member_type' or order_participants == 'desc' else 'desc', sort_members=sort_members, order_members=order_members) }}" style="text-align: left;">ä¼šå“¡ç¨®é¡</a></th>

            <th>å–æ¶ˆ</th>
          </tr>
        </thead>
        <tbody id="participants-table">
          <!-- JSã§åŸ‹ã‚è¾¼ã¿ -->
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- å…ˆã«ã‚¹ã‚¿ãƒ–ï¼ˆæœªå®šç¾©ã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰ -->
<script>window.reloadParticipantsTable = window.reloadParticipantsTable || (async () => {});</script>
<script src="{{ url_for('static', filename='js/match_edit.js') }}"></script>

<script>
  // --- QRå…¥åŠ›ã®åŸºæœ¬ ---
  const qrInput = document.getElementById('qr-input');
  const qrMsg   = document.getElementById('qr-msg');
  const qrClear = document.getElementById('qr-clear');

  // â˜…è¿½åŠ ï¼šéŸ³é–¢ä¿‚ã®è¦ç´ å‚ç…§
  const enableSoundBtn = document.getElementById('qr-sound-enable');   // è¿½åŠ ã—ãŸãƒœã‚¿ãƒ³
  const sndOK = document.getElementById('sound-ok');
  const sndNG = document.getElementById('sound-ng');

  function focusQr() { setTimeout(() => qrInput?.focus(), 0); }
  document.addEventListener('click', focusQr);
  window.addEventListener('load', focusQr);

  qrClear?.addEventListener('click', () => {
    qrInput.value = '';
    qrMsg.textContent = '';
    focusQr();
  });

  // â˜…è¿½åŠ ï¼šéŸ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆè‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼‰
  enableSoundBtn?.addEventListener('click', async () => {
    try {
      // ã»ã‚“ã®ä¸€ç¬ã ã‘å†ç”Ÿã—ã¦å³åœæ­¢ã™ã‚‹ã“ã¨ã§æ¨©é™ã‚’ç¢ºç«‹
      await sndOK.play(); sndOK.pause(); sndOK.currentTime = 0;
      await sndNG.play(); sndNG.pause(); sndNG.currentTime = 0;
      enableSoundBtn.textContent = 'ğŸ”Š éŸ³ON';
      enableSoundBtn.disabled = true;
    } catch (e) {
      alert('ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•å†ç”Ÿã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã™ã‹ã€QRå—ä»˜å¾Œã«æ‰‹å‹•ã§ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
    }
  });

  // â˜…è¿½åŠ ï¼šéŸ³å†ç”Ÿãƒ˜ãƒ«ãƒ‘ãƒ¼
  async function playSound(kind) {
    try {
      const el = kind === 'ok' ? sndOK : sndNG;
      if (!el) return;
      el.currentTime = 0;
      await el.play();
    } catch (e) {
      // å†ç”Ÿå¤±æ•—ã¯ç„¡è¦–ï¼ˆç„¡éŸ³ã§ç¶™ç¶šï¼‰
      // console.debug('sound play blocked:', e);
    }
  }

  // ===== ã“ã“ã‹ã‚‰ï¼šEnterä¸è¦ã®è‡ªå‹•å—ä»˜ãƒ­ã‚¸ãƒƒã‚¯ =====
  const TOKEN_RE = /^[a-z0-9]{16}$/;
  let scanTimer = null;
  let isSubmitting = false;
  let lastScan = { value: null, ts: 0 };

  async function submitScan() {
    if (isSubmitting) return;
    const token = (qrInput.value || '').trim().toLowerCase();
    if (!TOKEN_RE.test(token)) return;
    const now = Date.now();
    if (lastScan.value === token && (now - lastScan.ts) < 1000) {
      qrMsg.textContent = 'åŒã˜QRã‚³ãƒ¼ãƒ‰ã®é€£ç¶šèª­ã¿å–ã‚Šã‚’ç„¡è¦–ã—ã¾ã—ãŸ';
      qrMsg.style.color = '#e67e22';
      qrInput.value = '';
      focusQr();
      return;
    }
    lastScan = { value: token, ts: now };
 
    isSubmitting = true;
    // â˜…è¿½åŠ ï¼šé€ä¿¡ä¸­ã¯å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–ï¼ˆQRãƒªãƒ¼ãƒ€ãƒ¼ã®å¾Œç¶šã‚­ãƒ¼ã‚’å¸åï¼‰
    qrInput.disabled = true

    qrMsg.textContent = 'å—ä»˜ä¸­...';
    qrMsg.style.color = '#2c3e50';

    try {
      const res = await fetch('{{ url_for("api_scan_checkin") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ token })
      });
      const data = await res.json();

      if (!data.success) {
        qrMsg.textContent = data.message || 'å—ä»˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        qrMsg.style.color = '#c0392b';
        await playSound('ng');   // â˜…è¿½åŠ ï¼šå¤±æ•—éŸ³
      } else {
        qrMsg.textContent = data.message || 'å—ä»˜ã—ã¾ã—ãŸ';
        qrMsg.style.color = '#2c3e50';
        await playSound('ok');   // â˜…è¿½åŠ ï¼šæˆåŠŸéŸ³
        await reloadParticipantsTable();
      }
    } catch (err) {
      qrMsg.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š' + (err?.message || err);
      qrMsg.style.color = '#c0392b';
      await playSound('ng');     // â˜…è¿½åŠ ï¼šé€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚‚å¤±æ•—éŸ³
    } finally {
      isSubmitting = false;
      qrInput.disabled = false;
      qrInput.select();
      focusQr();
      clearTimeout(scanTimer);
    }
  }

  // â‘  EnteræŠ¼ä¸‹ã§ã‚‚å‹•ãï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
  qrInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(scanTimer);
      submitScan();
    }
  });

  // â‘¡ å…¥åŠ›ãŒæƒã£ãŸã‚‰è‡ªå‹•é€ä¿¡
  qrInput?.addEventListener('input', () => {
    clearTimeout(scanTimer);
    scanTimer = setTimeout(() => {
      const token = (qrInput.value || '').trim().toLowerCase();
      if (TOKEN_RE.test(token)) submitScan();
    }, 120);
  });
  // ===== ã“ã“ã¾ã§ï¼šè‡ªå‹•å—ä»˜ãƒ­ã‚¸ãƒƒã‚¯ =====
</script>

<script>
  // â–¼ æœ¬æ—¥ã®å‚åŠ è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
  window.reloadParticipantsTable = async function () {
    try {
      // ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTåŸºæº–ã® YYYY-MM-DDï¼‰
      const today = new Date(Date.now() - (new Date()).getTimezoneOffset()*60000)
                      .toISOString().slice(0,10);

      // ä¸¦ã³æ›¿ãˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆURLã‹ã‚‰å¼•ãç¶™ãï¼‰
      const params = new URLSearchParams(window.location.search);
      const sort  = params.get('sort_participants') || 'member_code';
      const order = params.get('order_participants') || 'asc';

      // å‚åŠ è€…ä¸€è¦§APIã‚’å–å¾—
      const url = `/api/participants?date=${encodeURIComponent(today)}&sort=${sort}&order=${order}&_=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' }});
      if (!res.ok) throw new Error('fetch failed');
      const list = await res.json();

      // ãƒ†ãƒ¼ãƒ–ãƒ«å·®ã—æ›¿ãˆ
      const tbody = document.getElementById('participants-table');
      if (!tbody) throw new Error('tbody not found: participants-table');

      tbody.innerHTML = '';
      for (const m of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.member_code ?? m.id ?? ''}</td>
          <td>${m.name ?? ''}</td>
          <td>${m.kana ?? ''}</td>
          <td>${m.grade ?? ''}</td>
          <td>${m.member_type ?? ''}</td>
          <td><button class="btn btn-outline remove-btn" data-id="${m.id}">å–æ¶ˆ</button></td>
        `;
        tbody.appendChild(tr);
      }

      // âœ… ã“ã“ã‚’è¿½åŠ ï¼šå‚åŠ è€…ä»¶æ•°ã«å¿œã˜ã¦ã€Œå¯¾å±€é€²è¡Œã¸ã€ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’å³æ™‚åæ˜ 
      (function enableProceedByCount() {
        const proceedBtn = document.getElementById('proceed-button');
        if (!proceedBtn) return;
        const hasParticipants = list.length > 0;
        proceedBtn.style.pointerEvents = hasParticipants ? 'auto' : 'none';
        proceedBtn.style.opacity       = hasParticipants ? '1'    : '0.5';
      })();

      // --- å·¦å´ã€Œå…¨ä¼šå“¡åç°¿ã€ã®è¡¨ç¤º/éè¡¨ç¤ºåŒæœŸï¼ˆå‚åŠ ä¸­ã¯éš ã™ï¼‰ ---
      try {
        const leftTbody = document.getElementById('members-table');
        if (leftTbody) {
          const idSet = new Set(list.map(p => String(p.id)));
          leftTbody.querySelectorAll('tr[data-id]').forEach(tr => {
            const mid = tr.getAttribute('data-id');
            tr.style.display = idSet.has(mid) ? 'none' : '';
            // ãƒã‚§ãƒƒã‚¯ã‚‚å®‰å…¨å´ã§å¤–ã—ã¦ãŠã
            const cb = tr.querySelector('input.member-check');
            if (cb && idSet.has(mid)) cb.checked = false;
          });
        }
      } catch (_) {
        /* å·¦è¡¨ãŒãªã„ã‚±ãƒ¼ã‚¹ã¯ç„¡è¦– */
      }

    } catch (err) {
      console.error(err);
    }
  };

  // â˜…è¿½åŠ ï¼šåˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚å¿…ãšæç”»
  window.addEventListener('load', () => { reloadParticipantsTable(); });
</script>

{% endblock %}
