{% extends "base.html" %}
{% block content %}

<h2 style="text-align: center; margin-bottom: 1.5rem;">会員名簿</h2>

<style>
  .table-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ccc;
  }

  .members-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .members-table th,
  .members-table td {
    padding: 4px 8px;
    text-align: center;
    border: 1px solid #ddd;
    white-space: nowrap;
    vertical-align: middle;
    line-height: 1.2;
  }

  .members-table thead th {
    position: sticky;
    top: 0;
    background-color: #2c3e50;
    color: #fff;
    z-index: 2;
  }

  .members-table th:nth-child(1),
  .members-table td:nth-child(1) { width: 80px; }   /* 会員ID(member_code) */
  .members-table th:nth-child(2),
  .members-table td:nth-child(2) { width: 120px; }  /* 名前 */
  .members-table th:nth-child(3),
  .members-table td:nth-child(3) { width: 120px; }  /* よみがな */
  .members-table th:nth-child(4),
  .members-table td:nth-child(4) { width: 100px; }  /* 棋力 */
  .members-table th:nth-child(5),
  .members-table td:nth-child(5) { width: 100px; }  /* 会員種類 */
  .members-table th:nth-child(6),
  .members-table td:nth-child(6),
  .members-table th:nth-child(7),
  .members-table td:nth-child(7) { width: 80px; }   /* 編集・削除 */
</style>

{% if imported %}
  <p style="color: green; text-align: center;">{{ imported }} 件の会員をインポートしました。</p>
{% endif %}

<div style="display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom: 1rem;">
  <!-- 新規会員を追加 -->
  <a href="{{ url_for('add_member') }}" class="btn">新規会員を追加</a>

  <!-- CSVからインポート（ボタン化） -->
  <button id="csv-import-btn" type="button" class="btn">CSVからインポート</button>

  <!-- 隠しフォーム（既存の upload_members を使用） -->
  <form id="csv-upload-form" method="post" action="{{ url_for('upload_members') }}" enctype="multipart/form-data" style="display:none;">
    <input id="csv-file-input" type="file" name="file" accept=".csv" />
  </form>

  <!-- エクスポート -->
  <a href="{{ url_for('export_members') }}" class="btn">CSVエクスポート</a>

  <!-- 右端に退会者ボタン -->
  <span style="flex:1"></span>
  <a href="{{ url_for('inactive_members') }}" class="btn" style="margin-left:auto;">退会者</a>
</div>

<p style="text-align: center; color: #555; margin-bottom: 1rem;">
  ※各項目名をクリックすると、項目により並び替え出来ます。
</p>

<div class="table-container">
  <table class="members-table" border="1">
    <thead>
      <tr>
        <th>
          <a href="{{ url_for('members', sort='member_code', order='asc' if sort != 'member_code' or order == 'desc' else 'desc') }}">
            会員ID {% if sort == 'member_code' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
          </a>
        </th>
        <th>
          <a href="{{ url_for('members', sort='name', order='asc' if sort != 'name' or order == 'desc' else 'desc') }}">
            名前 {% if sort == 'name' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
          </a>
        </th>
        <th>
          <a href="{{ url_for('members', sort='kana', order='asc' if sort != 'kana' or order == 'desc' else 'desc') }}">
            よみがな {% if sort == 'kana' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
          </a>
        </th>
        <th>
          <a href="{{ url_for('members', sort='grade', order='asc' if sort != 'grade' or order == 'desc' else 'desc') }}">
            棋力 {% if sort == 'grade' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
          </a>
        </th>
        <th>
          <a href="{{ url_for('members', sort='member_type', order='asc' if sort != 'member_type' or order == 'desc' else 'desc') }}">
            会員種類 {% if sort == 'member_type' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
          </a>
        </th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for m in members %}
      <tr>
        <td>{{ m.member_code or m.id }}</td>
        <td>{{ m.name }}</td>
        <td>{{ m.kana }}</td>
        <td>{{ m.grade }}</td>
        <td>{{ m.member_type }}</td>
        <td>
          <a href="{{ url_for('edit_member', member_id=m.id) }}" class="btn">編集</a>
        </td>
        <td>
          <form method="post" action="{{ url_for('delete_member', member_id=m.id) }}" onsubmit="return confirm('本当に削除しますか？');" style="display: inline;">
            <button type="submit" class="btn">退会</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<p style="text-align: center; margin-top: 2rem;">
  <a href="{{ url_for('index') }}" class="btn">← トップページに戻る</a>
</p>

<script>
  (function(){
    const btn = document.getElementById('csv-import-btn');
    const input = document.getElementById('csv-file-input');
    const form = document.getElementById('csv-upload-form');

    if (btn && input && form) {
      btn.addEventListener('click', function(){
        input.click();
      });
      input.addEventListener('change', function(){
        if (input.files && input.files.length > 0) {
          form.submit();
        }
      });
    }
  })();
</script>

{% endblock %}
