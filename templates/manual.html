{% extends "base.html" %}
{% block content %}

<style>
  /* ===== Manual Page Styles ===== */
  :root {
    --bg: #f7f7fb;
    --card: #ffffff;
    --ink: #1e293b;
    --sub: #475569;
    --brand: #0ea5e9;    /* アクセント */
    --brand-weak: #bae6fd;
    --line: #e2e8f0;
    --radius: 14px;
  }
  body { background: var(--bg); }
  .manual {
    max-width: 1120px;
    margin: 1rem auto 2rem;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 16px;
  }
  @media (max-width: 960px) {
    .manual {
      grid-template-columns: 1fr;
    }
  }

  /* ===== Side TOC ===== */
  .toc {
    position: sticky;
    top: 12px;
    align-self: start;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    padding: 14px 14px 8px;
    box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
  }
  .toc h3 {
    margin: 0 0 10px;
    font-size: 1.05rem;
    color: var(--ink);
  }
  .toc .search {
    display: flex;
    gap: 8px;
    margin: 6px 0 10px;
  }
  .toc input[type="search"] {
    flex: 1;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid var(--line);
    font-size: .95rem;
    outline: none;
  }
  .toc nav a {
    display: block;
    padding: 8px 10px;
    margin: 4px 0;
    border-radius: 10px;
    color: var(--ink);
    text-decoration: none;
    border: 1px solid transparent;
  }
  .toc nav a:hover,
  .toc nav a.is-hit {
    background: var(--brand-weak);
    border-color: var(--brand);
  }
  .toc small {
    display: block;
    color: var(--sub);
    margin-top: 8px;
  }

  /* ===== Main ===== */
  .main { min-width: 0; }
  .hero {
    background: linear-gradient(180deg, #fff, #f9fbff);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    padding: 22px 22px;
    box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
    margin-bottom: 12px;
  }
  .hero h1 {
    margin: 0 0 4px;
    font-size: clamp(1.35rem, 1.15rem + 1vw, 1.9rem);
    letter-spacing: .02em;
  }
  .hero p { margin: 6px 0 0; color: var(--sub); }

  /* ===== Section / Accordion ===== */
  section.manual-section {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    margin: 10px 0 14px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(15, 23, 42, 0.05);
  }
  section.manual-section > header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #ffffff;
    border-bottom: 1px solid var(--line);
  }
  section.manual-section h2 { font-size: 1.05rem; margin: 0; }
  details.block { border-top: 1px dashed var(--line); }
  details.block[open] summary { background: #fbfdff; }
  summary {
    cursor: pointer;
    list-style: none;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: var(--ink);
    border-bottom: 1px dashed var(--line);
  }
  summary::before {
    content: "▸";
    transition: transform .15s ease;
    color: var(--brand);
  }
  details[open] > summary::before { transform: rotate(90deg); }
  .block .content {
    padding: 12px 18px 16px 34px;
    color: var(--ink);
  }
  .note {
    background: #f0f9ff;
    border: 1px solid var(--brand-weak);
    color: #0b3a58;
    padding: 10px 12px;
    border-radius: 10px;
    margin: 8px 0;
  }
  .list { margin: 6px 0 0 1rem; padding: 0; }
  .list li { margin: 2px 0; }
  .pill {
    display: inline-block;
    background: var(--brand-weak);
    color: #0b3a58;
    border: 1px solid var(--brand);
    border-radius: 999px;
    padding: 2px 8px;
    font-size: .85rem;
    margin-left: 6px;
  }
  .anchor { text-decoration: none; color: var(--brand); }
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  }
  .muted { color: var(--sub); }
  .inline-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 720px) { .inline-grid { grid-template-columns: 1fr; } }
  .backtop { text-align: right; padding: 8px 14px 12px; border-top: 1px solid var(--line); }
  .backtop a { color: var(--brand); text-decoration: none; }
</style>

<div class="manual" id="top">
  <!-- ===== TOC ===== -->
  <aside class="toc">
    <h3>説明書 目次</h3>
    <div class="search">
      <input id="toc-search" type="search" placeholder="キーワード検索 (例: 昇段級)">
    </div>
    <nav id="toc-links">
      <a href="#sec-top">1. トップ画面</a>
      <a href="#sec-settings">2. 設定画面</a>
      <a href="#sec-members">3. 名簿管理画面</a>
      <a href="#sec-match">4. 対局画面</a>
      <a href="#sec-results">5. 成績管理画面</a>
      <a href="#sec-qr">6. QRコード生成画面</a>
    </nav>
    <small class="muted">ご利用前に、<span class="mono">設定 → 棋力 / 昇段級基準 / 駒落ち / デフォルト対局カード数</span> の順で初期設定を行ってください。</small>
  </aside>

  <!-- ===== MAIN ===== -->
  <main class="main">
    <div class="hero">
      <h1>KOMAYUI｜利用ガイド</h1>
      <p class="muted">本ガイドは Word 版の説明書の文言に忠実に構成し、現行の画面構成（目次・折りたたみ）で読みやすく再編集しています。</p>
    </div>

    <!-- 1. トップ画面 -->
    <section class="manual-section" id="sec-top">
      <header>
        <h2>1. トップ画面</h2>
        <span class="pill">概要</span>
      </header>

      <details class="block" open>
        <summary>トップ画面でできること</summary>
        <div class="content">
          <p>トップ画面では、以下の項目画面に移動することが出来ます。また、クラブのパスワード変更も可能です。</p>
          <div class="note">パスワードは半角英数字と「.」「_」「%」「+」「-」「@」が使用可能です。8文字以上でご設定ください。</div>
          <ul class="list">
            <li>設定画面</li>
            <li>名簿管理画面</li>
            <li>対局画面</li>
            <li>成績管理画面</li>
            <li>QRコード生成</li>
          </ul>
        </div>
      </details>
    </section>

    <!-- 2. 設定画面 -->
    <section class="manual-section" id="sec-settings">
      <header>
        <h2>2. 設定画面</h2>
        <span class="pill">基本設定</span>
      </header>

      <details class="block" open>
        <summary>設定画面の概要</summary>
        <div class="content">
          <p>設定画面では、「KOMAYUI」をあなたのクラブ・教室等で使用する上での基本的な事項を設定できます。</p>
        </div>
      </details>

      <details class="block" open>
        <summary>棋力の設定</summary>
        <div class="content">
          <p>はじめに「棋力の件数」を入力します。例えば、最下位の棋力が15級、最上位の棋力が六段であれば、15級から六段までの数を数えて入力します。</p>
          <div class="note">「未認定」は件数に含めません。</div>
          <p>件数を保存後、その件数分の入力欄が表示されます。1番目には最も低い棋力を入力し、順次入力して保存します。設定した棋力は後の昇段級・駒落ち設定と連動します。</p>
        </div>
      </details>

      <details class="block" open>
        <summary>昇段級基準の設定</summary>
        <div class="content">
          <p>昇段級基準とは、例えば「15級から10級までは3連勝」「9級から5級は5連勝または8勝2敗」といった昇段級条件を入力する画面です。</p>
          <p>棋力の下位→上位の行ごとに「連勝」「勝敗①（例：8勝2敗）」「勝敗②（例：10勝3敗）」の3系統へ入力します。空欄の条件は用いません。</p>
          <div class="note">いずれかの行で全て空欄のまま保存した場合は「昇段級条件が入力されていない項目があります」と警告されます。</div>
          <p>「8勝2敗」は「8回勝つまでに2敗まで許容」という意味であり、8勝1敗や8勝0敗でも条件を満たします（「2回負けなければならない」ではありません）。</p>
        </div>
      </details>

      <details class="block" open>
        <summary>駒落ちの設定</summary>
        <div class="content">
          <p>同格（0差）は「平手」、1差は「平手（下位先手）」、2差は「香落ち」など、段（級）差ごとの駒落ちを入力します。1〜15差それぞれをご入力ください。</p>
          <div class="note">16段（級）差以上の場合は、15段（級）差に入力した駒落ちが適用されます。</div>
        </div>
      </details>

      <details class="block" open>
        <summary>デフォルト対局カード数の設定</summary>
        <div class="content">
          <p>対局進行フェーズにおいて使用する対局カードのデフォルト枚数を設定できます。目安として、実際に設置する盤駒セットの数を入力することを推奨します。対局カードは対局進行フェーズで手動増減も可能です。</p>
        </div>
      </details>

      <div class="backtop"><a class="anchor" href="#top">↑ 一番上へ戻る</a></div>
    </section>

    <!-- 3. 名簿管理画面 -->
    <section class="manual-section" id="sec-members">
      <header>
        <h2>3. 名簿管理画面</h2>
        <span class="pill">会員情報</span>
      </header>

      <details class="block" open>
        <summary>名簿管理の概要</summary>
        <div class="content">
          <p>名簿管理画面では、会員ID・会員種類・名前・読み仮名・棋力を管理します。名簿の並び替え（会員ID順、よみがな順、棋力順、会員種類順）や、編集・退会処理も行えます。</p>
        </div>
      </details>

      <details class="block">
        <summary>会員ID・会員種類・名前・読み仮名・棋力</summary>
        <div class="content">
          <ul class="list">
            <li><b>会員ID：</b>半角英数字（メールで使用できる記号 ._%+-@ を含む）でクラブ内一意。</li>
            <li><b>会員種類：</b>「正会員」「臨時会員」「指導員」「スタッフ」から選択。</li>
            <li><b>名前：</b>日本語可。</li>
            <li><b>読み仮名：</b>全角ひらがな。</li>
            <li><b>棋力：</b>設定画面で定めた棋力から選択。昇段級時は自動更新されます。</li>
          </ul>
        </div>
      </details>

      <details class="block">
        <summary>CSVインポート / エクスポート</summary>
        <div class="content">
          <p>CSV インポートでは、<span class="mono">member_code / name / kana / grade / member_type</span> を取り込みます。既存の <span class="mono">member_code</span> は上書き更新されます。</p>
          <ul class="list">
            <li><b>member_code：</b>半角英数字 + <span class="mono">._%+-@</span>／20文字以内。違反行は取り込みしません。</li>
            <li><b>name：</b>20文字超は取り込みしません。</li>
            <li><b>kana：</b>ひらがなのみ（長音「ー」可）/ 50文字超は取り込みしません。</li>
            <li><b>grade：</b>マスタに無い値または空欄は「未認定」に置換えられます。</li>
            <li><b>member_type：</b>不明・空欄は「正会員」に置換えられます。</li>
            <li><b>必須：</b><span class="mono">member_code / name / kana</span> のいずれかが空欄ならその行は取り込みしません。</li>
            <li><b>エクスポート：</b>退会者は含まれません。</li>
          </ul>
        </div>
      </details>

      <details class="block">
        <summary>編集 / 退会（論理削除） / 退会者の扱い</summary>
        <div class="content">
          <p>行ごとの「編集」で会員情報を更新できます。「退会」で退会処理を行うと退会者リストへ移動します（完全削除は不可）。退会者は「復旧」で現役に戻せます。</p>
        </div>
      </details>

      <div class="backtop"><a class="anchor" href="#top">↑ 一番上へ戻る</a></div>
    </section>

    <!-- 4. 対局画面 -->
    <section class="manual-section" id="sec-match">
      <header>
        <h2>4. 対局画面</h2>
        <span class="pill">参加者編集 → 対局進行</span>
      </header>

      <details class="block" open>
        <summary>（1）参加者編集フェーズ</summary>
        <div class="content">
          <p>画面左側が全会員名簿、右側が「本日の参加者」です。</p>
          <ul class="list">
            <li>受付方法（2通り）：
              <ul class="list">
                <li>QRコード受付（会員カードのQRをリーダーで読み取り）</li>
                <li>チェックボックス選択 → 「参加受付」</li>
              </ul>
            </li>
            <li>受付取消が可能。各項目名クリックで並び替え。</li>
            <li>「対局進行へ」で進行フェーズへ（進行中に戻って追加/参加取消も可）。</li>
          </ul>
        </div>
      </details>

      <details class="block">
        <summary>（2）対局進行フェーズ（共通）</summary>
        <div class="content">
          <p>左に本日の参加者、右に対局カード群が並びます。参加者2名をドラッグしてカードに配置し、「対局開始」。終了時に結果を入力して「対局終了」で記録します。</p>
          <div class="note">同一組合せの2回目以降は警告表示。「勝てば昇段（級）」の事前表示あり。</div>
          <p>カードの操作：カード削除 / ＋カード追加 / 対局開始 / 手合い解除 / 対局終了</p>
        </div>
      </details>

      <details class="block">
        <summary>対局種別</summary>
        <div class="content">
          <ul class="list">
            <li><b>棋力認定戦：</b>勝敗を保存。条件達成で昇段級通知。</li>
            <li><b>指導対局：</b>勝敗の保存有無を選択可。「昇段級」ボタンで任意昇段級。</li>
            <li><b>フリー対局：</b>記録は残さない。</li>
            <li><b>初回認定戦：</b>未認定が片方にいる対局。終了時「棋力認定」ボタンで任意認定。未認定者の相手が勝った場合は「◇」（0.5勝）、負けは「◆」（ノーカウント）。</li>
          </ul>
          <p>駒落ち表示：棋力認定戦は棋力差から自動表示（手動変更可）／指導対局は「指導」／初回認定戦は「認定」。</p>
        </div>
      </details>

      <div class="backtop"><a class="anchor" href="#top">↑ 一番上へ戻る</a></div>
    </section>

    <!-- 5. 成績管理画面 -->
    <section class="manual-section" id="sec-results">
      <header>
        <h2>5. 成績管理画面</h2>
        <span class="pill">閲覧・編集・追加・削除</span>
      </header>

      <details class="block" open>
        <summary>成績一覧と出力</summary>
        <div class="content">
          <p>現役会員の成績一覧を表示します。集計期間の指定表示や CSV 出力に対応し、項目名クリックで並び替えができます。</p>
        </div>
      </details>

      <details class="block">
        <summary>個人成績表</summary>
        <div class="content">
          <p>成績一覧表の名前をクリックすると個人成績表が表示されます。成績期間を指定でき、CSV 出力も可能です。「昇段級履歴」と、「日付・相手名・相手棋力・駒落ち等・勝敗・備考」が表示されます。</p>
        </div>
      </details>

      <details class="block">
        <summary>活動外成績入力</summary>
        <div class="content">
          <p>クラブ外での昇段級を記録します（対象者・適用日・備考・新棋力）。適用日により勝敗カウントをリセットするかを選択できます。</p>
        </div>
      </details>

      <details class="block">
        <summary>昇段級履歴</summary>
        <div class="content">
          <p>昇段級の履歴を閲覧・編集・取消できます。取消時は履歴レコードを削除します（会員の現在棋力は自動では戻らないため、必要に応じて名簿管理画面から変更してください）。</p>
        </div>
      </details>

      <details class="block">
        <summary>対局の編集</summary>
        <div class="content">
          <p>対局一覧の閲覧・編集・追加・削除ができます。対局の追加・編集時に、昇段級に伴う勝敗カウントをリセットするかを選択できます。</p>
        </div>
      </details>

      <details class="block">
        <summary>勝敗カウント編集 / 勝敗カウントリセット編集 / 退会者</summary>
        <div class="content">
          <ul class="list">
            <li><b>勝敗カウント編集：</b>ブラインド勝敗（システム掲載対象外の事前勝敗列）を編集します。</li>
            <li><b>勝敗カウントリセット編集：</b>昇段級・活動外成績入力・対局編集（昇段級あり）等でリセットされた履歴を編集・追加・削除できます。</li>
            <li><b>退会者：</b>退会者の成績を閲覧できます。</li>
          </ul>
          <div class="note">
            <b>ブラインド勝敗とは？</b><br>
            KOMAYUI利用開始前に、例えば「2連勝中」「4勝1敗」などの勝敗カウントがある場合、その分をKOMAYUI利用開始前の日付で「〇〇●〇〇」のように記録しておき、以後の昇段級カウントに加算する仕組みです。
          </div>
        </div>
      </details>

      <div class="backtop"><a class="anchor" href="#top">↑ 一番上へ戻る</a></div>
    </section>

    <!-- 6. QRコード生成画面 -->
    <section class="manual-section" id="sec-qr">
      <header>
        <h2>6. QRコード生成画面</h2>
        <span class="pill">受付用QR / 個人成績公開URL</span>
      </header>

      <details class="block" open>
        <summary>QR の発行・再生成・トークンURL出力</summary>
        <div class="content">
          <p>参加受付で使用する QR コードデータの発行・再生成ができます。また、「QRトークンURLをCSV出力」では、各会員が自身の成績をログインなしで閲覧するための URL を出力できます。</p>
          <div class="note">
            <b>QRトークンURLについて</b><br>
            会員ごとに発行される複雑なトークン文字列を付した URL です。会員は自分の個人成績と全会員名簿を閲覧できます。<br>
            セキュリティ上、URL の漏洩には十分ご注意ください。漏洩等があった場合は「トークン再生成」で新しい QR コードと URL を再生成できます（既存の QR 、URL は無効になります）。
          </div>
        </div>
      </details>

      <div class="backtop"><a class="anchor" href="#top">↑ 一番上へ戻る</a></div>
    </section>
  </main>
</div>

<script>
  // ===== TOC Search (簡易フィルタ) =====
  const input = document.getElementById('toc-search');
  const links = Array.from(document.querySelectorAll('#toc-links a'));
  input?.addEventListener('input', (e) => {
    const q = (e.target.value || '').trim().toLowerCase();
    links.forEach(a => {
      const hit = a.textContent.toLowerCase().includes(q);
      a.style.display = hit ? 'block' : 'none';
      a.classList.toggle('is-hit', !!q && hit);
    });
  });

  // アンカーを開いた状態でスクロール（details内の見出しに飛んだ時の補助）
  document.querySelectorAll('a[href^="#"]').forEach(a => {
    a.addEventListener('click', () => {
      const id = a.getAttribute('href').slice(1);
      setTimeout(() => {
        const el = document.getElementById(id);
        if (!el) return;
        // セクション内の details をすべて開く
        el.querySelectorAll('details.block').forEach(d => d.open = true);
      }, 0);
    });
  });
</script>

{% endblock %}
